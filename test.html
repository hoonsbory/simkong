<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0" />
</head>

<body>

    <canvas id="myCanvas" style="display: none;">
    </canvas>
    <canvas id="copyCanvas" style="display: none;">
    </canvas>
    <p id="resultText"></p>
    <p id="resultText"></p>
    <script src="color-thief.umd.js"></script>
    <script class="jsbin" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="Jcrop.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fontfaceobserver/2.1.0/fontfaceobserver.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <div class="header">
        <h5 style="margin : 0">메뉴</h5>
    </div>


    <div id="mainbody">
        <div id="mainTitle">
            <p>나는 <span id="wormSpan">웜톤</span>일까? <span id="coolSpan">쿨톤</span>일까?</p>
            <span id="bgSpan">퍼스널컬러</span><span id="noBgSpan"> 진단</span>
        </div>
        <div id="subTitle">'톤.잘.알'이 되어 훈남,훈녀 되자!</div>
        <div id="stepInfo"><span id="stepNum">&nbsp;1</span><span id="subInfo">피부 사진 편집</span></div>
        <div id="cropNotice">※사각형에 피부만 꽉차게 편집해주세요</div>
        <div class="file-upload">

            <div class="image-upload-wrap">
                <input class="file-upload-input" id="fileInput" type='file' onclick="removeValue()"
                    onchange="readURL(this);" accept="image/*" />
                <div class="drag-text">
                    <img src="camera.png" />
                    <h1>내 피부 촬영하기 </h1>
                </div>
            </div>
            <div id="slider" style="display: none;">

                <ul>
                    <li>
                        <div class="file-upload-content">
                            <img class="file-upload-image" id="realImage" src="#" alt="your image" />
                            <div style="margin-top : 2vh">
                                <div class="btnGroup" id="editBtn" onclick="editImg()"><img
                                        src="crop.png"><span>자르기</span></div>
                                <div class="btnGroup" id="rotateBtn" onclick="rotateImg('right')"><img
                                        src="rotate.png"><span>회전</span></div>
                                <div class="btnGroup" id="refreshBtn" onclick="refresh()"><span
                                        style="padding-left: 0px">재설정</span></div>
                                <div class="btnGroup" onclick="crop()"><span style="padding-left: 0px">완료</span></div>
                            </div>
                            <div onclick="$('.file-upload-input').trigger( 'click' )" class="btnGroup" id="newfile">
                                <span>새로운 사진으로
                                    재시도</span></div>
                            <!-- <button id="cropImage" onclick="crop()" disabled="true">자르기</button> -->
                            <!-- <button type="button" id="leftBtn" onclick="rotateImg('left')">왼쪽으로 90도 회전</button> -->
                            <div class="arrowBtn"><img src="arrow.png" onclick="next()"><span  onclick="next()">다음 단계로</span></div>
                            <!-- <button onclick="next()">다음>></button> -->
                            <div id="failColor" style="display : none; height: 25px; width: 25px; border-radius: 15px;">
                            </div><span style="display: none;">사진의 상당부분이 피부색이 아닙니다. 다시 업로드하세요 </span>
                            <img id="originalImg" style="display: none;" />
                        </div>

                    </li>
                    <li>
                        <div class="question">
                            <p>1.나는 손목에 ○ ○색을 띄는 혈관이 많다</p>
                        </div>
                        <div class="choose" style="color: rgb(10, 59, 112);">
                            <div class="leftChoose" style="background-color: rgb(162,206,164);" onclick="moveRight('worm')"><span>초록색</span></div>
                            <div class="middleBar"></div>
                            <div class="rightChoose" style="background-color: rgb(153,198,228);" onclick="moveRight('cool')"><span>파란색</span></div>
                        </div>
                        <div id="askFooter">
                            <div id="leftBtn" class="arrowBtn"><img src="arrowLeft.png" onclick="moveLeft()"><span onclick="moveLeft()">이전 단계로</span></div>
                        </div>
                    </li>
                    <li>
                        <div class="question">
                            <p>2.나는 헤어컬러가 ○ ○에 가깝다</p>
                        </div>
                        <div class="choose" style="color: white;">
                            <div class="leftChoose" style="background-color: rgb(117,76,36);" onclick="moveRight('worm')"><span>브라운</span></div>
                            <div class="middleBar"></div>
                            <div class="rightChoose" style="background-color: black;" onclick="moveRight('cool')"><span>블랙</span></div>
                        </div>
                        <div id="askFooter">
                            <div id="leftBtn" class="arrowBtn"><img src="arrowLeft.png" onclick="moveLeft()"><span onclick="moveLeft()">이전 단계로</span></div>
                        </div>
                    </li>
                    <li>
                        <div class="question">
                            <p>3.나는 피부에 ○ ○ ○가 많다</p>
                        </div>
                        <div class="choose" style="color: rgb(10, 59, 112);">
                            <div class="leftChoose" style="background-color: rgb(253,215,153);" onclick="moveRight('worm')"><span>노란기</span></div>
                            <div class="middleBar"></div>
                            <div class="rightChoose" style="background-color: rgb(250,208,184);" onclick="moveRight('cool')"><span>붉은기</span></div>
                        </div>
                        <div id="askFooter">
                            <div id="leftBtn" class="arrowBtn"><img src="arrowLeft.png" onclick="moveLeft()"><span onclick="moveLeft()">이전 단계로</span></div>
                        </div>
                    </li>
                    <li>
                        <div class="question">
                            <p>4.나는 햇볕에 장시간 있으면</p>
                        </div>
                        <div class="choose" style="color: white;">
                            <div class="leftChoose" style="background-color: rgb(167,135,84);" onclick="moveRight('worm')"><span>쉽게 탄다</span></div>
                            <div class="middleBar"></div>
                            <div class="rightChoose" style="background-color: rgb(225,152,142);" onclick="moveRight('cool')"><span>빨갛게 익는다</span></div>
                        </div>
                        <div id="askFooter">
                            <div id="leftBtn" class="arrowBtn"><img src="arrowLeft.png" onclick="moveLeft()"><span onclick="moveLeft()">이전 단계로</span></div>
                        </div>
                    </li>
                    <li>
                        <div class="question">
                            <p>5.나는 ○ ○색 티셔츠가 더 잘어울린다</p>
                        </div>
                        <div class="choose" style="color: rgb(10, 59, 112);">
                            <div class="leftChoose" style="border-top: 4px solid rgb(253,245,226); border-bottom: 4px solid rgb(253,245,226); background-color: rgb(253,245,226);" onclick="moveRight('worm')"><span>아이보리 / 베이지</span></div>
                            <div class="middleBar"></div>
                            <div class="rightChoose" style="border-top: 4px solid rgb(253,245,226); border-bottom: 4px solid rgb(253,245,226); background-color: white;" onclick="moveRight('cool')"><span>순백색</span></div>
                        </div>
                        <div id="askFooter">
                            <div id="leftBtn" class="arrowBtn"><img src="arrowLeft.png" onclick="moveLeft()"><span onclick="moveLeft()">이전 단계로</span></div>
                        </div>
                    </li>
                </ul>
            </div>


        </div>
        <div id="notice">※퍼스널컬러 진단을 위해서 <p>&nbsp;&nbsp;<span
                    style="background-color: rgb(250,50,34); color: white; padding : 4px; padding-bottom: 0px;">팔목
                    안쪽</span> 피부 촬영이
                필요합니다.</p>
        </div>
    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        //폰트가 로드되기전까지 투명도를 줘서 안보이게 했다가 3초이내에 로딩되면 보이게함.
        //3초가 지나면 기본폰트로
        setTimeout(function () {
            document.body.style.opacity = 1
        }, 3000)
        var font = new FontFaceObserver('HSThin');
        font.load(null, 3000).then(function () {
            document.documentElement.classList.add('fonts-loaded');
        });

        //크롭없이 회전후 크롭할 경우  크롭을 하는 것은, 원본이미지를 캔버스에 옮겨오는 것으로 시작하는데, 크롭버튼을 누르지않고 회전부터 할 경우, 나중에 크롭할때 회전도가 달라 문제가 생긴다.
        //그래서 크롭을 시작하기전에 회전을 할 경우에만 한해서 캔버스에 그리고 시작한다. 사진을 올리자마자 캔버스에 그리는 게 편하지만, 편집을 원하지 않는 경우엔 불필요한 로딩을 하는 것이라 
        //따로 크롭 버튼을 넣은 것이다.
        var rotateCrop = false;
        //크롭버튼 클릭 유무. 크롭을 한적이 없다면 회전시 자동크롭
        var editCheck = false;

        //자르기버튼 비활성화를 위한 체크.
        var cropCheck = true;

        //첫 크롭여부 확인 후 처음인 경우만 드래그 안내
        var firstCrop = true;

        var uploadCheck = false;
        //업로드여부 체크해
        var slideCheck = 0;
        //슬라이드 위치체크

        //회전율
        var rotateRate = 0;
        //첫 비교 결과값을 담을 변수
        var firstResult = [];
        //비교 후 결과값을 담을 변수
        var calResult = [];
        
        //맨처음 색상분석을 위한 색상리스트
        var colorList = [
            [255, 233, 196],
            [254, 224, 174],
            [253, 215, 153],
            [244, 203, 149],
            [238, 219, 179],
            [238, 210, 160],
            [232, 191, 139],
            [223, 180, 112],
            [254, 236, 224],
            [255, 227, 213],
            [255, 222, 203],
            [250, 208, 184],
            [248, 230, 216],
            [249, 226, 208],
            [246, 216, 192],
            [236, 205, 177],
            //여기까지 톤색깔
            [220, 0, 18],//빨강
            [0, 152, 68],//초록
            [0, 159, 232],//하늘색
            [29, 32, 135],//파랑
            [126, 48, 141],//보라
            [255, 255, 255],//하양
            [0, 0, 0]//검정
        ]
        var wormColor = [
            [255, 233, 196],
            [254, 224, 174],
            [253, 215, 153],
            [244, 203, 149],
            [238, 219, 179],
            [238, 210, 160],
            [232, 191, 139],
            [223, 180, 112]

        ]
        var coolColor = [
            [254, 236, 224],
            [255, 227, 213],
            [255, 222, 203],
            [250, 208, 184],
            [248, 230, 216],
            [249, 226, 208],
            [246, 216, 192],
            [236, 205, 177]
        ]
        var imgRed;
        var imgGreen;
        var imgBlue;
        
        //답변 갯수를 종합해줄 스택
        var answerStack = [];

        //크롭을 위한 좌표값
        var x;
        var y;
        var w;
        var h;
        let jcropApi = null;
        var resizeCheck;

        var slideCount = $('#slider ul li').length;
        var slideWidth = $('#slider ul li').width();
        var slideHeight = $('#slider ul li').height();
        var sliderUlWidth = slideCount * slideWidth;


        $('#slider ul').css({ width: sliderUlWidth, marginLeft: - slideWidth });

        $('#slider ul li:last-child').prependTo('#slider ul');

        //리사이징이벤트
        window.addEventListener("resize", function () {
            if (window.innerWidth < 768 && resizeCheck != "mob") {
                resizeCheck = "mob";
                if (jcropApi) {
                    jcropApi.destroy();
                    jcropApi = null;
                    resize();
                }
            }
            else if ((window.innerWidth < 1024 && window.innerWidth > 767) && resizeCheck != "tab") {
                resizeCheck = "tab";
                if (jcropApi) {
                    jcropApi.destroy();
                    jcropApi = null;
                    resize();
                }
            } else if (window.innerWidth > 1023 && resizeCheck != "pc") {
                resizeCheck = "pc";
                if (jcropApi) {
                    jcropApi.destroy();
                    jcropApi = null;
                    resize();
                }
            }

        });
        function div() {
            document.getElementsByClassName("jcrop-holder")[0].lastElementChild.id = "jcropImg";
            document.getElementsByClassName("jcrop-holder")[0].lastElementChild.style.opacity = 0.6;
            if (firstCrop == false) {

                document.getElementsByClassName("jcrop-holder")[0].className = "jcrop-holder aft";
                document.getElementsByClassName("jcrop-holder")[0].lastElementChild.style.opacity = 1;
            } else {
                firstCrop = false;
            }

        }

        //뒤로가기
        function moveLeft() {
            slideCheck--;
            if (slideCheck == 0) {
                document.getElementById("cropNotice").style.display = "block"
                document.getElementById("stepNum").innerHTML = "\u00A01";
                document.getElementById("subInfo").innerHTML = "피부\u00A0사진\u00A0편집"
            }
            answerStack.pop();
            var slideWidth = $('#slider ul li').width();
            $('#slider ul').animate({

                left: + slideWidth
            }, 400, function () {
                $('#slider ul li:last-child').prependTo('#slider ul');
                $('#slider ul').css('left', '');
            });

        };
        //다음 단계로
        function moveRight(tone) {
            slideCheck++;
            if(slideCheck>0){
                document.getElementById("cropNotice").style.display = "none"
                document.getElementById("stepNum").innerHTML = "\u00A02";
                document.getElementById("subInfo").innerHTML = "질문\u00A05단계"
            }
            if (tone == "worm") {
                answerStack.push("worm");
            } else if (tone == "cool") {
                answerStack.push("cool");
            }
            if (slideCheck == 6) {
                var worm = 0;
                var cool = 0;
                for (var i = 0; i < answerStack.length; i++) {
                    if (answerStack[i] == "worm") {
                        worm++;
                    } else {
                        cool++;
                    }
                }
                if (worm < cool) {
                    season(coolColor,"cool");
                    return
                } else {
                    season(wormColor,"worm");
                    return
                }


            }

            var slideWidth = $('#slider ul li').width();
            $('#slider ul').animate({
                left: - slideWidth
            }, 400, function () {
                $('#slider ul li:first-child').appendTo('#slider ul');
                $('#slider ul').css('left', '');
            });

        };

        //이미지에서 색상추출
        function color() {
            var colorThief = new ColorThief();

            var sourceImage = document.getElementById("realImage");
            sourceImage.setAttribute('crossOrigin', '')

            console.log(
                colorThief.getColor(sourceImage)
            );

            // Display palette of colors
            // e.g [[55,37,29],[213,193,136],[110,204,223]]
            var imgRed = colorThief.getColor(sourceImage)[0];
            var imgGreen = colorThief.getColor(sourceImage)[1];
            var imgBlue = colorThief.getColor(sourceImage)[2];
            for (var i = 0; i < colorList.length; i++) {
                var color = "color" + i;
                var red = (imgRed - colorList[i][0]);
                red = red < 0 ? -(red) : red;
                var green = (imgGreen - colorList[i][1]);
                green = green < 0 ? -(green) : green;
                var blue = (imgBlue - colorList[i][2]);
                blue = blue < 0 ? -(blue) : blue;

                firstResult.push([red + green + blue, i]);
            }
            firstResult.sort(function (a, b) { // 오름차순 
                return a[0] - b[0];
            });
            var colorNum = firstResult[0][1];
            var colorThumbnail = "rgb(" + red + "," + green + "," + blue + ")"
            document.getElementById("failColor").style.backgroundColor = colorThumbnail;
            document.getElementById("failColor").style.display = "inline-block";
            document.getElementById("failColor").nextElementSibling.style.display = "inline-block"
            if (colorNum < 16) {
                moveRight("");
                uploadCheck = true;
                firstResult = [];
                return;
            } else if (colorNum == 16) {
                alert("사진이 너무 빨갛습니다.")
            } else if (colorNum == 17) {
                alert("사진이 너무 초록색입니다.")
            } else if (colorNum == 18) {
                alert("사진이 너무 하늘색입니다.")
            } else if (colorNum == 19) {
                alert("사진이 너무 파란색입니다.")
            } else if (colorNum == 20) {
                alert("사진이 너무 보라색입니다.")
            } else if (colorNum == 21) {
                alert("사진이 너무 하얀색입니다.")
            } else {
                alert("사진이 너무 검정색입니다.")
            }
            firstResult = [];

            // Display main color
            // e.g [125, 189, 193]
        }



        $('a.control_prev').click(function () {
            moveLeft();
        });

        $('a.control_next').click(function () {
            moveRight("aa");
        });



        //다음 버튼 눌렀을때 색상추출전이면 추출하고 아니면 다음단계로
        function next() {
            if (uploadCheck) {
                moveRight("");
            } else {
                color();
            }

        }
        function removeValue() {
            $("#fileInput").val("");
        }


        //자르기
        function crop() {
            if (cropCheck) {
                return;
            }
            cropCheck = true;
            uploadCheck = false;
            document.getElementById("refreshBtn").disabled = false;
            //로드된 이미지를 캔버스에 출력
            //복사용 캔버스에 복사함. 하나의 캔버스에서 자기 자신을 불러와 크롭해서 리드로우가 불가능하기 때문.
            let canvas = document.getElementById("myCanvas");

            let canvasContext = canvas.getContext("2d");



            // @breif 캔버스 크기를 이미지 크기와 동일하게 지정

            var imgWidth = document.getElementById("copyCanvas").width;
            var imgHeight = document.getElementById("copyCanvas").height;
            //캔버스와 비율을 맞추기 위해 메인 이미지의 크기로 나눈다. jcrop이 원본이미지 크기를 줄이기때문에, jcrop의 자식의 크기를 가져온다
            var xRate = imgWidth / document.getElementById("jcropImg").width;
            var yRate = imgHeight / document.getElementById("jcropImg").height;
            canvas.width = w * xRate;

            canvas.height = h * yRate;
            if (canvas.width == 0 || canvas.height == 0) {
                alert("더 이상 확대할 수 없습니다.")
                cropCheck = false;
                return;
            }
            canvasContext.drawImage(

                document.getElementById("copyCanvas")

                , x * xRate        // 자르기를 시작할 x좌표

                , y * yRate       // 자르기를 시작할 y좌표

                , w * xRate   // 잘라낸 이미지의 넓이

                , h * yRate    // 잘라낸 이미지의 높이

                , 0                                         // 캔버스에 이미지를 배치할 x좌표

                , 0                                         // 캔버스에 이미지를 배치할 y좌표

                , w * xRate  // 사용할 이미지의 넓이(이미지 스트레칭 또는 축소)

                , h * yRate  // 사용할 이미지의 높이(이미지 스트레칭 또는 축소)

            );

            // console.log(canvas.getContext('2d').getImageData(50,50, 1, 1).data);
            // getImageData로 특정 좌표의 컬러 값을 가져올 수 있다.

            // 로드된 이미지를 캔버스에 출력
            let canvas2 = document.getElementById("copyCanvas");

            let canvasContext2 = canvas2.getContext("2d");



            // @breif 캔버스 크기를 이미지 크기와 동일하게 지정

            canvas2.width = document.getElementById("myCanvas").width;

            canvas2.height = document.getElementById("myCanvas").height;

            canvasContext2.drawImage(

                document.getElementById("myCanvas"), 0, 0


            );



            if (jcropApi) {
                jcropApi.destroy();
                jcropApi = null;
            }
            // let canvas2 = document.getElementById("copyCanvas");

            // let canvasContext2 = canvas2.getContext("2d");
            // var image = new Image();
            // image.src = document.getElementById("realImage").src;
            // image.onload = function () {

            //     canvasContext2.drawImage(image, 0, 0, 200, 200);
            // }
            $(".file-upload-image").attr("src", getBase64Image());

            document.getElementById("realImage").style.transform = "none";
            rotateRate = 0;
            $("#realImage").Jcrop({
                onSelect: showCoords,
            }, function () {
                jcropApi = this;
                div();
            });





            // @details JCROP을 종료한다.




        };
        //이미지 경로 설정


        // function readURL(input) {
        //     if (input.files && input.files[0]) {

        //         if (jcropApi) {
        //             jcropApi.destroy();

        //             jcropApi = null;
        //         }
        //         var files = input.files;
        //         var fileType = files[0].type;
        //         loadImage(files[0], function (img, data) {
        //             img.toBlob(function (blob) {
        //                 var rotateFile = new File([blob], files[0].name, {
        //                     type: fileType
        //                 });
        //                 sel_file = rotateFile;
        //                 var reader = new FileReader();
        //                 reader.onload = function (e) {
        //                     $('.image-upload-wrap').hide();
        //                     $('.file-upload-image').removeAttr("style");
        //                     $('.file-upload-image').attr('src', e.target.result);
        //                     $('.file-upload-image').css("display", "none");
        //                     $('#realImage').attr('src', document.getElementById("ToneImage").getAttribute("src"));
        //                     $('.file-upload-content').show();

        //                     $('.image-title').html(input.files[0].name);
        //                     $("#realImage").Jcrop({
        //                         onSelect: showCoords
        //                     }, function () {
        //                         jcropApi = this;
        //                     });
        //                 }
        //                 reader.readAsDataURL(rotateFile);
        //             }, fileType)
        //         }, {
        //             orientation: true
        //         });//end loadImage



        //     } else {
        //         removeUpload();
        //     }
        // }  블롭을 통해 자동으로 로테이트하는 함수, 그러나 지원하지 않는 브라우저가 많아서 포기.


        //브라우저 리사이징시 크롭 새롭게 불러와서 크기 맞게 적용.
        function resize() {
            $("#realImage").Jcrop({
                onSelect: showCoords,
            }, function () {
                jcropApi = this;
                div2();
            });
            function div2() {
                document.getElementsByClassName("jcrop-holder")[0].lastElementChild.id = "jcropImg";
                document.getElementsByClassName("file-upload-image")[1].style.transform = "rotate( " + rotateRate + "deg )";
                document.getElementsByClassName("jcrop-holder")[0].firstElementChild.firstElementChild.firstElementChild.style.transform = "rotate( " + rotateRate + "deg )";
                if (firstCrop == false) {

document.getElementsByClassName("jcrop-holder")[0].className = "jcrop-holder aft";
document.getElementsByClassName("jcrop-holder")[0].lastElementChild.style.opacity = 1;
} else {
firstCrop = false;
}
            }
        }
        //업로드된 이미지를 jcrop라이브러리로 변환하고 이미지를 캔버스에 그려놓는다.
        async function editImg(callback,plusMinus) {
            editCheck = true;
            if(plusMinus){

            }else{
            document.getElementById('editBtn').style.pointerEvents = 'none';
            if(rotateCrop){
                document.getElementsByClassName("jcrop-holder aft")[0].className = "jcrop-holder";
                document.getElementsByClassName("jcrop-holder")[0].lastElementChild.id = "jcropImg";
                document.getElementsByClassName("jcrop-holder")[0].lastElementChild.style.opacity = 0.6;
                rotateCrop = false;
                return;
            }
            }
            document.getElementById("editBtn").style.animation = "fade 0.5s"
            setTimeout(() => {
                document.getElementById("editBtn").style.animation = "unset"
            }, 500);
            let canvas = document.getElementById("copyCanvas");

            let canvasContext = canvas.getContext("2d");

            // @breif 캔버스의 이미지

            var image = new Image();
            image.src = document.getElementById("originalImg").src;
            image.onload = function () {

                canvas.width = this.width;

                canvas.height = this.height;



                //안드로이드인 내 폰에서는 방향에 맞게 자동으로 회전되어 등록되지만 애플은 그렇지 않다. 애플은 정방향에서 90도회전된 정보가 사진에 들어가 있다.
                //예를 들면 정방향에서 찍었으면 회전값이 1이어야 하는데 애플은 8이 나온다. 그래서 애플 디바이스를 위한 회전 로직을 따로 짜야했다.
                //그리고 데스크탑 같은 경우, 크롬은 자동으로 정방향으로 나오지만 엣지는 회전되어 나온다. 기기 별 대응이 너무 많아지기 떄문에, 자체적으로 회전 로직을 추가했다.
                //크롭을 하기위해선 캔버스가 필요한데, 애플 기기에서 업로드시 img태그에는 정방향으로 나오지만 캔버스에는 회전이 적용되어 나오기 때문에, 피부를 특정해서 crop해야 하는
                //이 앱에서는 자동회전이 불가피하게 되어 넣게 됐다.
                if (navigator.userAgent.match(/iPhone|iPad|iPod|Mac/i) == null ? false : true) {
                    console.log("애플기기입니다.");
                    var fileInfo = document.getElementById("fileInput").files[0];
                    EXIF.getData(fileInfo, async () => {
                        const orientation = EXIF.getTag(fileInfo, "Orientation");
                        console.log("회전도는 " + orientation);
                        switch (orientation) {

                            // @details 이미지 회전값이 0인경우 ( 정방향 )
                            case undefined:
                                canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);
                                break;
                            case 1:


                                canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);
                                break;

                            case 3:


                                canvasContext.translate(canvas.width / 2, canvas.height / 2);
                                canvasContext.rotate(Math.PI);
                                canvasContext.translate(-canvas.width / 2, -canvas.height / 2);



                                // @details 이미지가 180° 회전 했을 경우 x, y축의 값을 업로드 이미지의 넓이와 높이를 음수로 변경한다.

                                canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);

                                break;

                            // @details 이미지 회전값이 270 기운 경우 ( 왼쪽으로 90 기운 경우 )
                            case 6:
                                if (canvas.width < canvas.height) {
                                    canvas.width = canvas.height;
                                } else {
                                    canvas.height = canvas.width;
                                }

                                canvasContext.translate(canvas.width / 2, canvas.height / 2);
                                canvasContext.rotate(Math.PI * 0.5);
                                canvasContext.translate(-canvas.width / 2, -canvas.height / 2);
                                canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);



                                // @details 이미지가 270° 회전 했을 경우 x축의 값을 업로드 이미지의 넓이를 음수로 변경한다.


                                break;

                            // @details 이미지 회전값이 90 기운 경우
                            case 8:
                                if (canvas.width < canvas.height) {
                                    canvas.width = canvas.height;
                                } else {
                                    canvas.height = canvas.width;
                                }

                                canvasContext.translate(canvas.width / 2, canvas.height / 2);
                                canvasContext.rotate(Math.PI * 1.5);
                                canvasContext.translate(-canvas.width / 2, -canvas.height / 2);
                                canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);

                                //회전하기전에 정사각형을 만들어주자.
                                break;
                        }

                    })
                } else {
                    canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);

                }
                $("#realImage").Jcrop({
                    onSelect: showCoords,
                }, function () {
                    jcropApi = this;
                    div();
                });

                // 사진편집을 누르면 편집 테두리가 전체를 감싸도록 설정
                $('.file-upload-content').show();
                callback(plusMinus);
                // firstCrop = true;
            }

        }

        //인풋창 파일 업로드 시 
        function readURL(input) {
            if (input.files && input.files[0]) {

                if (navigator.userAgent.indexOf("Android") > 0 ||
                    navigator.userAgent.indexOf("iPhone") > 0 ||
                    navigator.userAgent.indexOf("iPod") > 0 ||
                    navigator.userAgent.indexOf("BlackBerry") > 0) {
                    document.getElementById("stepNum").style.paddingRight = "1.2rem";
                    document.getElementById("stepNum").style.paddingTop = "0.3rem";
                }
                document.getElementById("subTitle").style.display = "none";
                document.getElementById("mainTitle").style.display = "none";
                document.getElementById("notice").style.display = "none";
                document.getElementById("stepInfo").style.display = "block";
                document.getElementById("cropNotice").style.display = "block";
                document.getElementById('editBtn').style.pointerEvents = 'auto';
                editCheck = false;
                if (jcropApi) {
                    jcropApi.destroy();

                    jcropApi = null;
                }
                firstCrop = true;
                const fileInfo = input.files[0];
                var reader = new FileReader();
                let tempImage = new Image();
                reader.onload = function (e) {
                    tempImage.src = e.target.result;
                    tempImage.onload = async function () {

                        // @breif 캔버스 위에 이미지 그리기

                        $('.image-upload-wrap').hide();
                        $('.file-upload-image').removeAttr("style");
                        $('#originalImg').attr('src', tempImage.src);
                        $('.file-upload-image').attr('src', tempImage.src);


                        // $('.file-upload-image').css("display", "none");
                        // $('#realImage').attr('src', e.target.result);
                        $('#slider').show();
                        uploadCheck = false;
                    };


                    //회전값이 있는 사진을 정방향으로 돌리는 로직을 짜려했지만, 디바이스마다 회전값을 처리하는 기준이 달라서(특히 애플) 결국 포기하고 
                    //있는 그대로의 사진을 올리고 유저가 회전시킬 수 있게 바꾸었다...


                    // canvasContext.drawImage(tempImage, 0, 0, canvas.width, canvas.height);

                    //     await EXIF.getData(fileInfo, async () => {
                    //         // if (navigator.userAgent.indexOf('Mobile') != -1) {
                    //         //     canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);
                    //         //     // console.log("모바일기기입니다.")
                    //         //     return
                    //         // }
                    //         fileInfo.exifdata = null;
                    //         console.log(EXIF.getAllTags(fileInfo));
                    //         const orientation = EXIF.getTag(fileInfo, "Orientation");
                    //         console.log("회전도는 "+orientation);

                    //         switch (orientation) {

                    //             // @details 이미지 회전값이 0인경우 ( 정방향 )
                    //             case undefined:

                    //                 canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);
                    //                 $('.image-upload-wrap').hide();
                    // $('.file-upload-image').removeAttr("style");
                    // $('.file-upload-image').attr('src', getBase64Image());

                    //  $('#originalImg').attr('src', getBase64Image());
                    //   $("#realImage").Jcrop({
                    //     onSelect: showCoords,
                    // }, function () {
                    //     jcropApi = this;
                    // });

                    // // $('.file-upload-image').css("display", "none");
                    // // $('#realImage').attr('src', e.target.result);
                    // $('.file-upload-content').show();
                    // $('.image-title').html(input.files[0].name);
                    //             //    callback(canvas);

                    //                 break;
                    //             case 1:

                    //                 canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);
                    //                 break;
                    //             case 0:

                    //                 canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);
                    //                 break;
                    //             // @details 이미지 회전값이 180 기운 경우
                    //             case 3:
                    //                 // document.getElementById("realImage").style.transform = "rotate( 180deg )";
                    //                 // document.getElementById("originalImg").style.transform = "rotate( 180deg )";
                    //                 // document.getElementsByClassName("file-upload-image")[1].style.transform = "rotate( 180deg )";
                    //                 // document.getElementsByClassName("jcrop-holder")[0].firstElementChild.firstElementChild.firstElementChild.style.transform = "rotate(180deg)";





                    //                 // canvasContext.rotate((180) * Math.PI / 180);

                    //                 canvasContext.translate(canvas.width / 2, canvas.height / 2);
                    //                 canvasContext.rotate(Math.PI);
                    //                 canvasContext.translate(-canvas.width / 2, -canvas.height / 2);




                    //                 // @details 이미지가 180° 회전 했을 경우 x, y축의 값을 업로드 이미지의 넓이와 높이를 음수로 변경한다.

                    //                 canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);

                    //                 break;

                    //             // @details 이미지 회전값이 270 기운 경우 ( 왼쪽으로 90 기운 경우 )
                    //             case 6:
                    //                 if (canvas.width < canvas.height) {
                    //                     canvas.width = canvas.height;
                    //                 } else {
                    //                     canvas.height = canvas.width;
                    //                 }
                    //                 // document.getElementById("realImage").style.transform = "rotate( 90deg )";
                    //                 // document.getElementById("originalImg").style.transform = "rotate( 90deg )";
                    //                 // document.getElementsByClassName("file-upload-image")[1].style.transform = "rotate( 90deg )";
                    //                 // document.getElementsByClassName("jcrop-holder")[0].firstElementChild.firstElementChild.firstElementChild.style.transform = "rotate(90deg)";
                    //                 // @details 270° 회전의 경우 이미지의 높이와 넓이를 서로 바꿔준다.


                    //                 // tempImage.src = document.getElementById("ToneImage").getAttribute("src");
                    //                 // canvasContext.save();
                    //                 // canvasContext.translate(tempImage.width / 2, tempImage.height / 2);
                    //                 // canvasContext.rotate(Math.PI * 0.5);

                    //                 // canvasContext.drawImage(this, -1490,-0);

                    //                 // canvasContext.restore();
                    //                 console.log("ㅅㅂ");
                    //                 canvasContext.translate(canvas.width / 2, canvas.height / 2);
                    //                 canvasContext.rotate(Math.PI * 0.5);
                    //                 canvasContext.translate(-canvas.width / 2, -canvas.height / 2);
                    //                 canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);



                    //                 // @details 이미지가 270° 회전 했을 경우 x축의 값을 업로드 이미지의 넓이를 음수로 변경한다.


                    //                 break;

                    //             // @details 이미지 회전값이 90 기운 경우
                    //             case 8:
                    //                 //회전하기전에 정사각형을 만들어주자.
                    //                 if (canvas.width < canvas.height) {
                    //                     canvas.width = canvas.height;
                    //                 } else {
                    //                     canvas.height = canvas.width;
                    //                 }
                    //                 // document.getElementById("realImage").style.transform = "rotate( 270deg )";
                    //                 // document.getElementById("originalImg").style.transform = "rotate( 270deg )";
                    //                 // document.getElementsByClassName("file-upload-image")[1].style.transform = "rotate( 270deg )";
                    //                 // document.getElementsByClassName("jcrop-holder")[0].firstElementChild.firstElementChild.firstElementChild.style.transform = "rotate(270deg)";
                    //                 // @details 90° 회전의 경우 이미지의 높이와 넓이를 서로 바꿔준다.




                    //                 // canvasContext.rotate((90) * Math.PI / 180);

                    //                 //캔버스의 중심점 설정.
                    //                 canvasContext.translate(canvas.width / 2, canvas.height / 2);
                    //                 canvasContext.rotate(Math.PI * 1.5);
                    //                 //회전시킨 후 다시 중심점 0,0으로 설정.
                    //                 canvasContext.translate(-canvas.width / 2, -canvas.height / 2);


                    //                 // @details 이미지가 90° 회전 했을 경우 y축의 값을 업로드 이미지의 높이를 음수로 변경한다.
                    //                 canvasContext.drawImage(this, 0, 0, canvas.width, canvas.height);
                    //                 break;
                    //         }
                    //     });
                    // let dataURI = canvas.toDataURL("image/jpeg");

                    // document.querySelector("#ToneImage").src = dataURI;



                }

                reader.readAsDataURL(fileInfo);


            } else {
                removeUpload();
            }
        }


        //이미지 회전.
         function rotateImg(plusMinus) {
            document.getElementById("rotateBtn").style.animation = "fade 0.5s"
            setTimeout(() => {
                document.getElementById("rotateBtn").style.animation = "unset"
            }, 500);
            if (plusMinus == "right") {
                rotateRate += 90;
            } else {
                rotateRate -= 90;
            }

            if (rotateRate == 360 || rotateRate == -360) {
                rotateRate = 0;
            }

            if(!editCheck){
                firstCrop = false;
                rotateCrop = true;
                //캔버스에 그림이 그려진 후 회전을 시켜야해서 콜백함수로 순서를 맞춤.
                 editImg(rotateCall,plusMinus);
             
            }else{
                rotateCall(plusMinus);
            }
            

        }
        function rotateCall(plusMinus){
            let canvas = document.getElementById("copyCanvas");

            let canvasContext = canvas.getContext("2d");

            let rotateCanvas = document.getElementById("myCanvas");
            let rtx = rotateCanvas.getContext("2d");
            document.getElementById("realImage").style.transform = "rotate( " + rotateRate + "deg )";
            document.getElementById("originalImg").style.transform = "rotate( " + rotateRate + "deg )";
            if(document.getElementsByClassName("jcrop-holder")[0]){
            document.getElementsByClassName("file-upload-image")[1].style.transform = "rotate( " + rotateRate + "deg )";
            document.getElementsByClassName("jcrop-holder")[0].firstElementChild.firstElementChild.firstElementChild.style.transform = "rotate( " + rotateRate + "deg )";

            }
            rotateCanvas.width = canvas.width;
            rotateCanvas.height = canvas.height;

            if (rotateCanvas.width < rotateCanvas.height) {
                rotateCanvas.width = rotateCanvas.height;
            } else {
                rotateCanvas.height = rotateCanvas.width;
            }

            // 캔버스의 중심점 설정.
            rtx.translate(rotateCanvas.width / 2, rotateCanvas.height / 2);
            if (plusMinus == "right") {
                rtx.rotate(Math.PI * 0.5);
            } else {
                rtx.rotate(Math.PI * -0.5);

            }
            rtx.translate(-rotateCanvas.width / 2, -rotateCanvas.height / 2);
            rtx.drawImage(canvas, 0, 0, rotateCanvas.width, rotateCanvas.height);



            //회전용 캔버스의 내용을 다시 메인 캔버스에 복사해준다. 이미지를 회전시켜 캔버스에 그리면 편하나, 원래 이미지를 회전시킨건 단순 css를 통한 회전이다
            //캔버스에는 회전이 적용되지않은 원래의 이미지가 그려지기 때문에 메인캔버스의 그림을 불러와 서브캔버스에 회전한 상태를 그린 후, 다시 서브에서 메인으로 옮겨 그린다.
            canvas.width = rotateCanvas.width;
            canvas.height = rotateCanvas.height;

            canvasContext.drawImage(rotateCanvas, 0, 0, rotateCanvas.width, rotateCanvas.height);
        }
        function removeUpload() {
            $('.file-upload-input').replaceWith($('.file-upload-input').clone());
            $('.file-upload-content').hide();
            $('.image-upload-wrap').show();
        }
        $('.image-upload-wrap').bind('dragover', function () {
            $('.image-upload-wrap').addClass('image-dropping');
        });
        $('.image-upload-wrap').bind('dragleave', function () {
            $('.image-upload-wrap').removeClass('image-dropping');
        });



        //크롭 영역 지정 이벤트 함수
        var showCoords = function (c) {
            cropCheck = false;
            if (document.getElementsByClassName("jcrop-holder")[0]) {
                document.getElementsByClassName("jcrop-holder")[0].className = "jcrop-holder aft";
            }

            x = c.x;
            y = c.y;
            w = c.w;
            h = c.h;
        };

        //캔버스의 이미지를 base64로 변환
        function getBase64Image() {

            var canvas = document.getElementById("copyCanvas");

            var dataURL = canvas.toDataURL("image/png");

            return dataURL; // dataURL.replace(/^data:image\/(png|jpg);base64,/, "");

        }


        //사진 원상복구. 숨겨놓앗던 오리지널 이미지태그를 불러와 캔버스에 다시그림
        function refresh() {
            document.getElementById("refreshBtn").style.animation = "fade 0.5s"
            setTimeout(() => {
                document.getElementById("refreshBtn").style.animation = "unset"
            }, 500);
            uploadCheck = false;
            cropCheck = true;
            document.getElementById("refreshBtn").disabled = true;
            document.getElementById("originalImg").style.transform = "none";
            var image = new Image();
            image.src = document.getElementById("originalImg").src;
            document.getElementById("realImage").src = image.src;
            document.getElementsByClassName("file-upload-image")[1].src = image.src;
            document.getElementsByClassName("jcrop-holder")[0].firstElementChild.firstElementChild.firstElementChild.src = image.src;
            document.getElementsByClassName("file-upload-image")[1].style.transform = "none";
            document.getElementsByClassName("jcrop-holder")[0].firstElementChild.firstElementChild.firstElementChild.style.transform = "none";

            var canvas = document.getElementById("copyCanvas");
            var canvasContext = canvas.getContext("2d");



            // canvasContext.drawImage(image, 0, 0, canvas.width, canvas.height);

            image.onload = function () {
                canvas.width = this.width;
                canvas.height = this.height;
                if (navigator.userAgent.match(/iPhone|iPad|iPod|Mac/i) == null ? false : true) {
                    console.log("애플기기입니다.");
                    var fileInfo = document.getElementById("fileInput").files[0];
                    EXIF.getData(fileInfo, async () => {
                        const orientation = EXIF.getTag(fileInfo, "Orientation");
                        console.log("회전도는 " + orientation);
                        switch (orientation) {

                            // @details 이미지 회전값이 0인경우 ( 정방향 )

                            case 1:


                                canvasContext.drawImage(image, 0, 0, canvas.width, canvas.height);
                                break;

                            case 3:


                                canvasContext.translate(canvas.width / 2, canvas.height / 2);
                                canvasContext.rotate(Math.PI);
                                canvasContext.translate(-canvas.width / 2, -canvas.height / 2);



                                // @details 이미지가 180° 회전 했을 경우 x, y축의 값을 업로드 이미지의 넓이와 높이를 음수로 변경한다.

                                canvasContext.drawImage(image, 0, 0, canvas.width, canvas.height);

                                break;

                            // @details 이미지 회전값이 270 기운 경우 ( 왼쪽으로 90 기운 경우 )
                            case 6:
                                if (canvas.width < canvas.height) {
                                    canvas.width = canvas.height;
                                } else {
                                    canvas.height = canvas.width;
                                }

                                canvasContext.translate(canvas.width / 2, canvas.height / 2);
                                canvasContext.rotate(Math.PI * 0.5);
                                canvasContext.translate(-canvas.width / 2, -canvas.height / 2);
                                canvasContext.drawImage(image, 0, 0, canvas.width, canvas.height);



                                // @details 이미지가 270° 회전 했을 경우 x축의 값을 업로드 이미지의 넓이를 음수로 변경한다.


                                break;

                            // @details 이미지 회전값이 90 기운 경우
                            case 8:
                                if (canvas.width < canvas.height) {
                                    canvas.width = canvas.height;
                                } else {
                                    canvas.height = canvas.width;
                                }

                                canvasContext.translate(canvas.width / 2, canvas.height / 2);
                                canvasContext.rotate(Math.PI * 1.5);
                                canvasContext.translate(-canvas.width / 2, -canvas.height / 2);
                                canvasContext.drawImage(image, 0, 0, canvas.width, canvas.height);

                                //회전하기전에 정사각형을 만들어주자.x
                                break;
                        }


                    })
                } else {
                    canvasContext.drawImage(image, 0, 0, canvas.width, canvas.height);



                }
            }

        }
        // run the webcam image through the image model
        // function apiTest() {
        //     $.ajax({
        //         url: "https://eng-contact-277115.dt.r.appspot.com/apiTest",
        //         type: "post",
        //         data: document.getElementById("realImage").src,
        //         contentType: 'application/json;charset=UTF-8',
        //         success: function (data) {
        //             imgRed = data.red;
        //             imgGreen = data.green;
        //             imgBlue = data.blue;
        //             for(var i =0; i<colorList.length;i++){
        //                 var color = "color" + i;
        //         var red = (imgRed - colorList[i][0]);
        //         red = red < 0 ? -(red) : red;
        //         var green = (imgGreen - colorList[i][1]);
        //         green = green < 0 ? -(green) : green;
        //         var blue = (imgBlue - colorList[i][2]);
        //         blue = blue < 0 ? -(blue) : blue;

        //         firstResult.push([red + green + blue, i]);
        //             }
        //             firstResult.sort(function (a, b) { // 오름차순 
        //         return a[0] - b[0];
        //     });
        //     var colorNum = firstResult[0][1];
        //     var colorThumbnail = "rgb("+red+","+green+","+blue+")"
        //     document.getElementById("failColor").style.backgroundColor = colorThumbnail;
        //     document.getElementById("failColor").style.display = "inline-block";
        //     document.getElementById("failColor").nextElementSibling.style.display = "inline-block"
        //         if(colorNum<16){
        //             moveRight("");
        //             document.getElementById("btnGroup").style.display = "none";
        //             uploadCheck = true;
        //             firstResult = [];
        //             return;
        //         }else if(colorNum==16){
        //             alert("사진이 너무 빨갛습니다.")
        //         }else if(colorNum==17){
        //             alert("사진이 너무 초록색입니다.")
        //         }else if(colorNum==18){
        //             alert("사진이 너무 하늘색입니다.")
        //         }else if(colorNum==19){
        //             alert("사진이 너무 파란색입니다.")
        //         }else if(colorNum==20){
        //             alert("사진이 너무 보라색입니다.")
        //         }else if(colorNum==21){
        //             alert("사진이 너무 하얀색입니다.")
        //         }else{
        //             alert("사진이 너무 검정색입니다.")
        //         }
        //         firstResult = [];

        //         }, error: function () {
        //             alert("실패")
        //         }
        //     })

        // }

        //색상과 질문 총 결과값을 종합하여 결과 도출
        function season(colorGroup,toneColor) {
            for (var i = 0; i < colorGroup.length; i++) {
                var color = "color" + i;
                var red = (imgRed - colorGroup[i][0]); 
                red = red < 0 ? -(red) : red;
                var green = (imgGreen - colorGroup[i][1]);
                green = green < 0 ? -(green) : green;
                var blue = (imgBlue - colorGroup[i][2]);
                blue = blue < 0 ? -(blue) : blue;

                calResult.push([red + green + blue, i]);

            }
            calResult.sort(function (a, b) { // 오름차순 
                return a[0] - b[0];
            });
            var colorNum = calResult[0][1];
            if (0 <= colorNum && colorNum <= 3 && toneColor == "worm") {
                document.getElementById("resultText").innerText = "봄 웜톤입니다!"
            } else if (toneColor == "worm") {
                document.getElementById("resultText").innerText = "가을 웜톤입니다!"
            } else if (0 <= colorNum && colorNum <= 3 && toneColor == "cool") {
                document.getElementById("resultText").innerText = "여름 쿨톤입니다!"
            } else {
                document.getElementById("resultText").innerText = "겨울 쿨톤입니다!"
            }

            calResult = [];
        }



    </script>
    <script>

        /**
        *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function () { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://personalcolor.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
</body>

</html>